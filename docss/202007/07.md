# 分表分库 shardingsphere

## 1. `yml`配置文件简单实现

默认的 `Hikari` 数据库连接池不支持 `shardingsphere`需要改造才行，因此先适用 `druid` 数据库连接池

> 添加依赖

```
<dependency>
    <groupId>org.apache.shardingsphere</groupId>
    <artifactId>sharding-jdbc-spring-boot-starter</artifactId>
    <version>${sharding.jdbc.version}</version>
</dependency>
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid</artifactId>
    <version>1.1.23</version>
</dependency>
```

配置文件demo

```
spring:
  redis:
    host: 121.196.58.164
    port: 6379
    password: redis123
    timeout: 3600
    jedis:
      pool:
        max-active: 8
        max-idle: 8
        max-wait: -1ms
        min-idle: 0
    database: 1
  # 数据源
  shardingsphere:
    datasource:
      names: master
      master:
        #type: com.zaxxer.hikari.HikariDataSource
        type: com.alibaba.druid.pool.DruidDataSource
        driver-class: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://rm-bp11pgpytkd97de62fo.mysql.rds.aliyuncs.com:3306/tinycrow?usrSSL=true&useUnicode=true&characterEncoding=utf-8&serverTimezone=Asia/Shanghai
        username: tinycrow
        password: zzw!0613*QMY
    # 分表配置
    sharding:
      tables:
        cont_article_comment:
          actual-data-nodes: master.cont_article_comment_${0..3}
          table-strategy:
            inline:
              sharding-column:  `article_id`
              algorithm-expression: cont_article_comment_${article_id.longValue() % 4}
```

> `guava` `jar`包冲突

在引入了`shardingsphere`依赖后，与`swagger` 的`guava`冲突了，解决方式，引入更高版本的 `guava`

```java
<dependency>
    <groupId>com.google.guava</groupId>
    <artifactId>guava</artifactId>
    <version>29.0-jre</version>
</dependency>
```

> 测试

用 `Mybatis-plus` 的默认 `service save`方法测试插入不同 `article_id`的评论，分别插入对应表中

查询同样适用  `Mybatis-plus` 的默认方法查询也没有问题